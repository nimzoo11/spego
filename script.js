// Í≤åÏûÑ ÏÉÅÌÉú
const gameState = {
    money: 10000,
    currentBet: null,
    betAmount: 0,
    betChoice: null, // 'black', 'white', 'draw'
    gamePhase: 'waiting', // waiting, betting, playing, result
    countdown: 10,
    board: Array(5).fill(null).map(() => Array(5).fill(null)),
    currentPlayer: 'black',
    moveCount: 0,
    gameHistory: [],
    stats: {
        totalBet: 0,
        totalWin: 0,
        gamesPlayed: 0,
        gamesWon: 0
    },
    globalBets: {
        black: 1000,
        white: 1000,
        draw: 1000
    }
};

// DOM ÏöîÏÜå
const elements = {
    userMoney: document.getElementById('userMoney'),
    gameStatus: document.getElementById('gameStatus'),
    countdown: document.getElementById('countdown'),
    blackStatus: document.getElementById('blackStatus'),
    whiteStatus: document.getElementById('whiteStatus'),
    board: document.getElementById('badukBoard'),
    scoreDisplay: document.getElementById('scoreDisplay'),
    blackScore: document.getElementById('blackScore'),
    whiteScore: document.getElementById('whiteScore'),
    betBlack: document.getElementById('betBlack'),
    betDraw: document.getElementById('betDraw'),
    betWhite: document.getElementById('betWhite'),
    betAmount: document.getElementById('betAmount'),
    betInputSection: document.getElementById('betInputSection'),
    currentBet: document.getElementById('currentBet'),
    betChoice: document.getElementById('betChoice'),
    betMoney: document.getElementById('betMoney'),
    expectedWin: document.getElementById('expectedWin'),
    cancelBetBtn: document.getElementById('cancelBetBtn'),
    chargeBtn: document.getElementById('chargeBtn'),
    chargeModal: document.getElementById('chargeModal'),
    historyList: document.getElementById('historyList'),
    totalBet: document.getElementById('totalBet'),
    totalWin: document.getElementById('totalWin'),
    netProfit: document.getElementById('netProfit'),
    winRate: document.getElementById('winRate'),
    blackBetAmount: document.getElementById('blackBetAmount'),
    whiteBetAmount: document.getElementById('whiteBetAmount'),
    drawBetAmount: document.getElementById('drawBetAmount'),
    blackBar: document.getElementById('blackBar'),
    whiteBar: document.getElementById('whiteBar'),
    drawBar: document.getElementById('drawBar'),
    blackPercent: document.getElementById('blackPercent'),
    whitePercent: document.getElementById('whitePercent'),
    drawPercent: document.getElementById('drawPercent')
};

// Î∞îÎëëÌåê Ï¥àÍ∏∞Ìôî
function initBoard() {
    const size = 5;
    const cellSize = 80;
    const padding = 40;
    const boardSize = cellSize * (size - 1) + padding * 2;

    elements.board.setAttribute('width', boardSize);
    elements.board.setAttribute('height', boardSize);
    elements.board.innerHTML = '';

    // Í∑∏Î¶¨Îìú Í∑∏Î¶¨Í∏∞
    for (let i = 0; i < size; i++) {
        // Í∞ÄÎ°úÏÑ†
        const hLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        hLine.setAttribute('x1', padding);
        hLine.setAttribute('y1', padding + i * cellSize);
        hLine.setAttribute('x2', padding + (size - 1) * cellSize);
        hLine.setAttribute('y2', padding + i * cellSize);
        hLine.setAttribute('stroke', '#000');
        hLine.setAttribute('stroke-width', '2');
        elements.board.appendChild(hLine);

        // ÏÑ∏Î°úÏÑ†
        const vLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        vLine.setAttribute('x1', padding + i * cellSize);
        vLine.setAttribute('y1', padding);
        vLine.setAttribute('x2', padding + i * cellSize);
        vLine.setAttribute('y2', padding + (size - 1) * cellSize);
        vLine.setAttribute('stroke', '#000');
        vLine.setAttribute('stroke-width', '2');
        elements.board.appendChild(vLine);
    }

    // ÌôîÏ†ê (Ï§ëÏïô)
    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.setAttribute('cx', padding + 2 * cellSize);
    dot.setAttribute('cy', padding + 2 * cellSize);
    dot.setAttribute('r', '4');
    dot.setAttribute('fill', '#000');
    elements.board.appendChild(dot);
}

// Îèå ÎÜìÍ∏∞
function placeStone(x, y, color) {
    const cellSize = 80;
    const padding = 40;
    const radius = 30;

    const stone = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    stone.setAttribute('cx', padding + x * cellSize);
    stone.setAttribute('cy', padding + y * cellSize);
    stone.setAttribute('r', radius);
    
    if (color === 'black') {
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
        gradient.setAttribute('id', `blackGrad${x}${y}`);
        gradient.innerHTML = `
            <stop offset="0%" style="stop-color:#4a4a4a;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#000;stop-opacity:1" />
        `;
        elements.board.appendChild(gradient);
        stone.setAttribute('fill', `url(#blackGrad${x}${y})`);
    } else {
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
        gradient.setAttribute('id', `whiteGrad${x}${y}`);
        gradient.innerHTML = `
            <stop offset="0%" style="stop-color:#fff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ddd;stop-opacity:1" />
        `;
        elements.board.appendChild(gradient);
        stone.setAttribute('fill', `url(#whiteGrad${x}${y})`);
        stone.setAttribute('stroke', '#999');
        stone.setAttribute('stroke-width', '2');
    }

    stone.setAttribute('class', 'stone');
    stone.style.opacity = '0';
    elements.board.appendChild(stone);

    // Ïï†ÎãàÎ©îÏù¥ÏÖò
    setTimeout(() => {
        stone.style.transition = 'opacity 0.3s';
        stone.style.opacity = '1';
    }, 10);

    gameState.board[y][x] = color;
}

// Í∞ÑÎã®Ìïú AI Î°úÏßÅ (ÎûúÎç§ÌïòÍ≤å Îπà Í≥≥Ïóê ÎÜìÍ∏∞)
function getAIMove() {
    const emptySpots = [];
    for (let y = 0; y < 5; y++) {
        for (let x = 0; x < 5; x++) {
            if (gameState.board[y][x] === null) {
                emptySpots.push({ x, y });
            }
        }
    }

    if (emptySpots.length === 0) return null;

    // ÏïΩÍ∞ÑÏùò Ï†ÑÎûµ: Ï§ëÏïô ÏÑ†Ìò∏
    const centerSpots = emptySpots.filter(spot => 
        (spot.x === 2 || spot.y === 2) && emptySpots.length > 10
    );

    const spots = centerSpots.length > 0 ? centerSpots : emptySpots;
    return spots[Math.floor(Math.random() * spots.length)];
}

// Í≤åÏûÑ ÌîåÎ†àÏù¥
async function playGame() {
    gameState.gamePhase = 'playing';
    gameState.board = Array(5).fill(null).map(() => Array(5).fill(null));
    gameState.currentPlayer = 'black';
    gameState.moveCount = 0;
    
    elements.gameStatus.textContent = 'Í≤åÏûÑ ÏßÑÌñâÏ§ë!';
    elements.scoreDisplay.style.display = 'none';
    initBoard();

    // Î≤†ÌåÖ Î∂àÍ∞Ä
    disableBetting();

    // Ìïú ÏàòÏî© ÎëêÍ∏∞ (1Ï¥à Í∞ÑÍ≤©)
    const maxMoves = 25; // 5x5 = 25Ïπ∏
    
    for (let i = 0; i < maxMoves; i++) {
        const move = getAIMove();
        if (!move) break;

        // AI ÏÉÅÌÉú ÌëúÏãú
        if (gameState.currentPlayer === 'black') {
            elements.blackStatus.textContent = 'ÏÉùÍ∞ÅÏ§ë...';
            elements.blackStatus.classList.add('thinking');
            elements.whiteStatus.textContent = 'ÎåÄÍ∏∞Ï§ë';
            elements.whiteStatus.classList.remove('thinking');
        } else {
            elements.whiteStatus.textContent = 'ÏÉùÍ∞ÅÏ§ë...';
            elements.whiteStatus.classList.add('thinking');
            elements.blackStatus.textContent = 'ÎåÄÍ∏∞Ï§ë';
            elements.blackStatus.classList.remove('thinking');
        }

        await sleep(1000); // 1Ï¥à ÎåÄÍ∏∞

        placeStone(move.x, move.y, gameState.currentPlayer);
        gameState.moveCount++;

        // ÌÑ¥ Î≥ÄÍ≤Ω
        gameState.currentPlayer = gameState.currentPlayer === 'black' ? 'white' : 'black';

        // 30Ï¥à Ï†ÑÍπåÏßÄ Î≤†ÌåÖ Ï∑®ÏÜå Í∞ÄÎä•
        const remainingTime = 50 - gameState.moveCount;
        if (remainingTime === 20 && gameState.currentBet) {
            elements.cancelBetBtn.style.display = 'none';
        }
    }

    // Í≤åÏûÑ Ï¢ÖÎ£å, Í≤∞Í≥º Í≥ÑÏÇ∞
    elements.blackStatus.textContent = 'ÎåÄÍ∏∞Ï§ë';
    elements.blackStatus.classList.remove('thinking');
    elements.whiteStatus.textContent = 'ÎåÄÍ∏∞Ï§ë';
    elements.whiteStatus.classList.remove('thinking');

    await sleep(1000);
    calculateResult();
}

// Ï†êÏàò Í≥ÑÏÇ∞ (Í∞ÑÎã®Ìïú Ïßë Í≥ÑÏÇ∞)
function calculateResult() {
    let blackScore = 0;
    let whiteScore = 0;

    // Ïã§Ï†úÎ°úÎäî Î≥µÏû°Ìïú ÏïåÍ≥†Î¶¨Ï¶òÏù¥ ÌïÑÏöîÌïòÏßÄÎßå, Í∞ÑÎã®ÌïòÍ≤å Îèå Í∞úÏàòÎ°ú Í≥ÑÏÇ∞
    for (let y = 0; y < 5; y++) {
        for (let x = 0; x < 5; x++) {
            if (gameState.board[y][x] === 'black') blackScore++;
            else if (gameState.board[y][x] === 'white') whiteScore++;
        }
    }

    // ÏïΩÍ∞ÑÏùò ÎûúÎç§ÏÑ± Ï∂îÍ∞Ä (Ï†êÏàò Ï°∞Ï†ï)
    blackScore += Math.floor(Math.random() * 3);
    whiteScore += Math.floor(Math.random() * 3);

    // Îç§ (Î∞±ÏóêÍ≤å Ïú†Î¶¨ÌïòÍ≤å)
    whiteScore += 3.5;

    elements.blackScore.textContent = blackScore.toFixed(1);
    elements.whiteScore.textContent = whiteScore.toFixed(1);
    elements.scoreDisplay.style.display = 'flex';

    let result;
    const diff = Math.abs(blackScore - whiteScore);
    
    if (diff < 0.5) {
        result = 'draw';
        elements.gameStatus.textContent = 'ü§ù Î¨¥ÏäπÎ∂Ä!';
    } else if (blackScore > whiteScore) {
        result = 'black';
        elements.gameStatus.textContent = '‚ö´ AI-A(Ìùë) ÏäπÎ¶¨!';
    } else {
        result = 'white';
        elements.gameStatus.textContent = '‚ö™ AI-B(Î∞±) ÏäπÎ¶¨!';
    }

    // Î≤†ÌåÖ Í≤∞Í≥º Ï≤òÎ¶¨
    processResult(result);
}

// Í≤∞Í≥º Ï≤òÎ¶¨
function processResult(result) {
    gameState.gamePhase = 'result';
    
    let won = false;
    let winAmount = 0;

    if (gameState.currentBet) {
        if (gameState.betChoice === result) {
            won = true;
            const odds = result === 'draw' ? 2.9 : 1.95;
            winAmount = Math.floor(gameState.betAmount * odds);
            gameState.money += winAmount;
            gameState.stats.totalWin += winAmount;
            gameState.stats.gamesWon++;
        }
        
        gameState.stats.gamesPlayed++;
        
        // ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä
        addHistory(result, won, winAmount);
    }

    updateUI();

    // 10Ï¥à ÌõÑ Îã§Ïùå Í≤åÏûÑ
    setTimeout(() => {
        startNewGame();
    }, 5000);
}

// ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä
function addHistory(result, won, winAmount) {
    const resultText = result === 'black' ? 'AI-A Ïäπ' : 
                      result === 'white' ? 'AI-B Ïäπ' : 'Î¨¥ÏäπÎ∂Ä';
    
    const betText = gameState.betChoice === 'black' ? 'AI-A' : 
                    gameState.betChoice === 'white' ? 'AI-B' : 'Î¨¥ÏäπÎ∂Ä';

    const item = document.createElement('div');
    item.className = `history-item ${won ? 'win' : 'lose'}`;
    item.innerHTML = `
        <div>
            <div style="font-weight: bold;">${resultText}</div>
            <div style="font-size: 11px; color: #666;">Î≤†ÌåÖ: ${betText} ${gameState.betAmount.toLocaleString()}Ïõê</div>
        </div>
        <div style="font-weight: bold; color: ${won ? '#28a745' : '#dc3545'}">
            ${won ? '+' : ''}${(winAmount - gameState.betAmount).toLocaleString()}Ïõê
        </div>
    `;

    if (elements.historyList.querySelector('.history-empty')) {
        elements.historyList.innerHTML = '';
    }

    elements.historyList.insertBefore(item, elements.historyList.firstChild);

    // ÏµúÎåÄ 10Í∞úÎßå ÌëúÏãú
    while (elements.historyList.children.length > 10) {
        elements.historyList.removeChild(elements.historyList.lastChild);
    }
}

// ÏÉà Í≤åÏûÑ ÏãúÏûë
function startNewGame() {
    gameState.gamePhase = 'waiting';
    gameState.currentBet = null;
    gameState.betAmount = 0;
    gameState.betChoice = null;
    gameState.countdown = 10;
    
    elements.currentBet.style.display = 'none';
    elements.betInputSection.style.display = 'block';
    elements.cancelBetBtn.style.display = 'none';
    elements.scoreDisplay.style.display = 'none';
    
    // Î≤†ÌåÖ ÏòµÏÖò Ï¥àÍ∏∞Ìôî
    document.querySelectorAll('.bet-option').forEach(opt => {
        opt.classList.remove('selected', 'disabled');
    });

    // Í∞ÄÏÉÅÏùò Îã§Î•∏ ÏÇ¨Ïö©Ïûê Î≤†ÌåÖ Ï∂îÍ∞Ä
    gameState.globalBets.black += Math.floor(Math.random() * 5000);
    gameState.globalBets.white += Math.floor(Math.random() * 5000);
    gameState.globalBets.draw += Math.floor(Math.random() * 2000);

    updateBettingStats();
    updateUI();

    // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥
    const timer = setInterval(() => {
        gameState.countdown--;
        elements.countdown.textContent = gameState.countdown;
        
        if (gameState.countdown <= 0) {
            clearInterval(timer);
            elements.gameStatus.textContent = 'Í≤åÏûÑ ÏãúÏûë!';
            playGame();
        } else {
            elements.gameStatus.textContent = `Îã§Ïùå Í≤åÏûÑ ÏãúÏûëÍπåÏßÄ`;
        }
    }, 1000);
}

// Î≤†ÌåÖ ÎπÑÌôúÏÑ±Ìôî
function disableBetting() {
    document.querySelectorAll('.bet-option').forEach(opt => {
        opt.classList.add('disabled');
        opt.style.pointerEvents = 'none';
    });
}

// Î≤†ÌåÖ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
function updateBettingStats() {
    elements.blackBetAmount.textContent = gameState.globalBets.black.toLocaleString();
    elements.whiteBetAmount.textContent = gameState.globalBets.white.toLocaleString();
    elements.drawBetAmount.textContent = gameState.globalBets.draw.toLocaleString();

    const total = gameState.globalBets.black + gameState.globalBets.white + gameState.globalBets.draw;
    const blackPercent = Math.round((gameState.globalBets.black / total) * 100);
    const whitePercent = Math.round((gameState.globalBets.white / total) * 100);
    const drawPercent = 100 - blackPercent - whitePercent;

    elements.blackBar.style.width = `${blackPercent}%`;
    elements.whiteBar.style.width = `${whitePercent}%`;
    elements.drawBar.style.width = `${drawPercent}%`;

    elements.blackPercent.textContent = `${blackPercent}%`;
    elements.whitePercent.textContent = `${whitePercent}%`;
    elements.drawPercent.textContent = `${drawPercent}%`;
}

// UI ÏóÖÎç∞Ïù¥Ìä∏
function updateUI() {
    elements.userMoney.textContent = gameState.money.toLocaleString();
    elements.totalBet.textContent = gameState.stats.totalBet.toLocaleString();
    elements.totalWin.textContent = gameState.stats.totalWin.toLocaleString();
    
    const netProfit = gameState.stats.totalWin - gameState.stats.totalBet;
    elements.netProfit.textContent = netProfit.toLocaleString();
    elements.netProfit.className = netProfit > 0 ? 'positive' : netProfit < 0 ? 'negative' : 'neutral';

    const winRate = gameState.stats.gamesPlayed > 0 ? 
        Math.round((gameState.stats.gamesWon / gameState.stats.gamesPlayed) * 100) : 0;
    elements.winRate.textContent = winRate;
}

// Î≤†ÌåÖÌïòÍ∏∞
function placeBet(choice) {
    if (gameState.gamePhase !== 'waiting') return;
    
    const amount = parseInt(elements.betAmount.value);
    
    if (amount < 1000 || amount > 100000) {
        alert('Î≤†ÌåÖ Í∏àÏï°ÏùÄ 1,000Ïõê ~ 100,000Ïõê ÏÇ¨Ïù¥Ïó¨Ïïº Ìï©ÎãàÎã§.');
        return;
    }

    if (amount > gameState.money) {
        alert('Î≥¥Ïú† Í∏àÏï°Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
        return;
    }

    // Í∏∞Ï°¥ Î≤†ÌåÖ Ï∑®ÏÜå
    if (gameState.currentBet) {
        gameState.globalBets[gameState.betChoice] -= gameState.betAmount;
    }

    gameState.currentBet = { choice, amount };
    gameState.betChoice = choice;
    gameState.betAmount = amount;
    gameState.money -= amount;
    gameState.stats.totalBet += amount;

    // Í∏ÄÎ°úÎ≤å Î≤†ÌåÖÏóê Ï∂îÍ∞Ä
    gameState.globalBets[choice] += amount;

    // UI ÏóÖÎç∞Ïù¥Ìä∏
    document.querySelectorAll('.bet-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.getElementById(`bet${choice.charAt(0).toUpperCase() + choice.slice(1)}`).classList.add('selected');

    const choiceText = choice === 'black' ? 'AI-A ÏäπÎ¶¨' : 
                      choice === 'white' ? 'AI-B ÏäπÎ¶¨' : 'Î¨¥ÏäπÎ∂Ä';
    const odds = choice === 'draw' ? 2.9 : 1.95;
    const expectedWin = Math.floor(amount * odds);

    elements.betChoice.textContent = choiceText;
    elements.betMoney.textContent = amount.toLocaleString();
    elements.expectedWin.textContent = expectedWin.toLocaleString();
    elements.currentBet.style.display = 'block';
    elements.betInputSection.style.display = 'none';
    elements.cancelBetBtn.style.display = 'block';

    updateUI();
    updateBettingStats();
}

// Î≤†ÌåÖ Ï∑®ÏÜå
function cancelBet() {
    if (!gameState.currentBet) return;

    gameState.money += gameState.betAmount;
    gameState.stats.totalBet -= gameState.betAmount;
    gameState.globalBets[gameState.betChoice] -= gameState.betAmount;

    gameState.currentBet = null;
    gameState.betChoice = null;
    gameState.betAmount = 0;

    elements.currentBet.style.display = 'none';
    elements.betInputSection.style.display = 'block';
    elements.cancelBetBtn.style.display = 'none';

    document.querySelectorAll('.bet-option').forEach(opt => {
        opt.classList.remove('selected');
    });

    updateUI();
    updateBettingStats();
}

// Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
elements.betBlack.addEventListener('click', () => placeBet('black'));
elements.betWhite.addEventListener('click', () => placeBet('white'));
elements.betDraw.addEventListener('click', () => placeBet('draw'));
elements.cancelBetBtn.addEventListener('click', cancelBet);

// Îπ†Î•∏ Î≤†ÌåÖ Í∏àÏï°
document.querySelectorAll('.btn-quick').forEach(btn => {
    btn.addEventListener('click', () => {
        elements.betAmount.value = btn.dataset.amount;
    });
});

// Ï∂©Ï†Ñ Î™®Îã¨
elements.chargeBtn.addEventListener('click', () => {
    elements.chargeModal.style.display = 'block';
});

document.querySelector('.close').addEventListener('click', () => {
    elements.chargeModal.style.display = 'none';
});

window.addEventListener('click', (e) => {
    if (e.target === elements.chargeModal) {
        elements.chargeModal.style.display = 'none';
    }
});

// Ï∂©Ï†ÑÌïòÍ∏∞
document.querySelectorAll('.btn-charge-option').forEach(btn => {
    btn.addEventListener('click', () => {
        const amount = parseInt(btn.dataset.amount);
        gameState.money += amount;
        updateUI();
        elements.chargeModal.style.display = 'none';
        alert(`${amount.toLocaleString()}ÏõêÏù¥ Ï∂©Ï†ÑÎêòÏóàÏäµÎãàÎã§!`);
    });
});

document.getElementById('confirmChargeBtn').addEventListener('click', () => {
    const amount = parseInt(document.getElementById('customAmount').value);
    if (amount && amount >= 1000) {
        gameState.money += amount;
        updateUI();
        elements.chargeModal.style.display = 'none';
        document.getElementById('customAmount').value = '';
        alert(`${amount.toLocaleString()}ÏõêÏù¥ Ï∂©Ï†ÑÎêòÏóàÏäµÎãàÎã§!`);
    } else {
        alert('ÏµúÏÜå 1,000Ïõê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
    }
});

// Ï¥àÍ∏∞Ìôî
initBoard();
updateUI();
updateBettingStats();
startNewGame();

